<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<!-- namespace: 해당 mapper파일의 고유한 별칭 -->
<mapper namespace="memberMapper">
	
	<resultMap type="Member" id="memberResult">
		<result column="USER_NO" property="userNo"/>
		<result column="USER_ID" property="userId"/>
		<result column="USER_PWD" property="userPwd"/>
		<result column="USER_NAME" property="userName"/>
		<result column="GENDER" property="gender"/>
		<result column="NICKNAME" property="nickname"/>
		<result column="BIRTH" property="birth"/>
		<result column="ENROLL_DATE" property="enrollDate"/>
		<result column="MODIFY_DATE" property="modifyDate"/>
		<result column="INTRODUCE" property="introduce"/>
		<result column="PROFILE_IMG" property="profileImg"/>
		<result column="POINT" property="point"/>
		<result column="STATUS" property="status"/>
		<result column="ADMIN" property="admin"/>
	</resultMap>
	
	<resultMap type="Picked" id="pickedResult">
		<result column="PICKED_NO" property="pickedNo"/>
		<result column="USER_NO" property="userNo"/>
		<result column="CLUB_NO" property="clubNo"/>	
	</resultMap>
	
	<!-- 로그인 쿼리문 -->
	<select id="loginMember" resultMap="memberResult">
		SELECT user_no,
				user_id,
				user_pwd,
				user_name,
				gender,
				nickname,
				phone,
				birth,
				enroll_date,
				modify_date,
				introduce,
				profile_img,
				point,
				status, 
				admin
				FROM member
				where user_id = #{userId}
				and user_pwd = #{userPwd}
				and status = 'Y'
	</select>
	
	<!-- 닉네임중복체크 -->
	<select id="nickNameCheck" parameterType="String" resultType="_int">
		SELECT COUNT(*) as result
		  FROM MEMBER
		 WHERE NICKNAME = #{nickname}
		   AND status = 'Y'
	</select>
	
	<!-- 아이디중복체크 -->
	<select id="idCheck" parameterType="String" resultType="_int">
		SELECT COUNT(*) as result
		  FROM MEMBER
		 WHERE USER_ID = #{checkId}
		   AND status = 'Y'
	</select>
	
	<!-- 회원가입 -->
	<insert id="insertMember">
		INSERT INTO MEMBER(
		user_no,
		   USER_ID,
		   USER_PWD,
			nickname
		)
		VALUES(
			NEXTVAL('SEQ_UNO'),
		   #{userId},
		   #{userPwd},
		   #{nickname}
		)
	</insert>
	
	<!-- 회원정보 수정 -->
	<update id="updateMember">
		UPDATE MEMBER
		   SET nickname = #{nickname},
		       profile_Img = #{profileImg},
		       introduce = #{introduce},
		       phone = #{phone},
		       MODIFY_DATE = CURRENT_DATE
		WHERE USER_NO = #{userNo}
	</update>
	
	<!-- 비밀번호 확인 -->
	<select id="pwdCheck"  resultType="string">
        SELECT USER_PWD
          FROM MEMBER
         where user_id = #{userId}
    </select>
	
	
	<!-- 회원 비밀번호 수정 -->
	<update id="updatePassword">
		UPDATE MEMBER
		   SET USER_PWD = #{userPwd},
		       MODIFY_DATE = CURRENT_TIMESTAMP
		WHERE USER_ID = #{userId}
	</update>
	
	<!-- 회원 탈퇴 -->
	<update id="deleteMember">
		UPDATE MEMBER
		   SET STATUS = 'N'
		 WHERE USER_ID = #{userId}
	</update>
	
	<!-- 포인트 업데이트 -->
	<update id="updatePointRq">
		UPDATE MEMBER
			SET point = point - #{point}
		WHERE USER_NO = #{userNo}
	</update>
	
	<!-- cno에 참여중인 맴버 -->
	<select id="participatedMemberList" resultMap="memberResult">
		SELECT M.USER_NO,
			   NICKNAME,
			   INTRODUCE,
			   PROFILE_IMG
		FROM MEMBER M 
		JOIN REQUEST R USING (USER_NO)
		WHERE R.STATUS = 'Y'
			AND R.CLUB_NO = #{cno}
		ORDER BY CREATE_DATE ASC;
	</select>
	
	<select id="ajaxSelectPicked" resultMap="pickedResult">
		SELECT PICKED_NO,
			   USER_NO,
			   CLUB_NO
		FROM PICKED
		WHERE USER_NO = #{userNo}
			and CLUB_NO = #{clubNo}
	</select>
	
	<insert id="ajaxInsertPicked">
		INSERT INTO PICKED(
			PICKED_NO,
			USER_NO,
			CLUB_NO
		)
		VALUES(
			NEXTVAL('SEQ_PNNO'),
			#{userNo},
			#{clubNo}
		) 
	</insert>
	
	<delete id="ajaxDeletePicked">
		DELETE FROM PICKED
		WHERE USER_NO = #{userNo}
			AND CLUB_NO = #{clubNo}
	</delete>
	
	<!-- cno에 요청한 request 전부 (수락,거절,대기) -->
	<select id="requestMemberList" resultMap="memberResult">
		SELECT M.USER_NO,
			   NICKNAME,
			   INTRODUCE,
			   PROFILE_IMG
		FROM MEMBER M 
		JOIN REQUEST R USING (USER_NO)
		WHERE R.CLUB_NO = #{cno} 
			AND R.STATUS != 'F'
		ORDER BY CREATE_DATE ASC;
	</select>
	
	<update id="chargePoint">
		UPDATE MEMBER
			SET point = point + #{point}
		WHERE USER_NO = #{userNo}
	</update>
	
	<update id="withdrawPoint">
		UPDATE MEMBER
			SET point = point - #{point}
		WHERE USER_NO = #{userNo}
	</update>
	
	<select id="selectClubLeader" resultMap="memberResult">
		SELECT DISTINCT M.USER_NO,
			   NICKNAME,
			   INTRODUCE,
			   PROFILE_IMG
		FROM MEMBER M
		JOIN CLUB C USING (USER_NO)
		WHERE C.CLUB_NO = #{cno}
	</select>
	
	<select id="getUserNoByUserId" resultType="_int">
		SELECT COALESCE(
		    (SELECT USER_NO
		     FROM MEMBER
		     WHERE USER_ID = #{userId}),
		    0) AS USER_NO
	</select>
	
	<select id="selectNicknameByUserNo" resultType="string">
		SELECT NICKNAME
		FROM MEMBER
		WHERE USER_NO = #{userNo}
	</select>
	
	<!-- 간편로그인 이메일 중복 확인 (네이버, 카카오, 구글) -->
   <select id="findUserByEmail" parameterType="string" resultMap="memberResult">
       SELECT * 
       FROM MEMBER 
       WHERE USER_ID = #{userId}
   </select>
   
   <update id="refundPointM"> 
  		UPDATE MEMBER
		   SET point = point + #{point}
		 WHERE USER_NO = #{userNo}
   </update>
   
</mapper>