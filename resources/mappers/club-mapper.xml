<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<!-- namespace: 해당 mapper파일의 고유한 별칭 -->
<mapper namespace="clubMapper"> 
	<resultMap type="Club" id="clubResult">
		<result column="CLUB_NO" property="clubNo"/>
		<result column="USER_NO" property="userNo"/>
		<result column="CLUB_TITLE" property="clubTitle"/>
		<result column="CLUB_TYPE" property="clubType"/>
		<result column="CLUB_CONTENT" property="clubContent"/>
		<result column="ADDRESS" property="address"/>
		<result column="ADDRESS_DETAIL" property="addressDetail"/>
		<result column="EVENT_DATE" property="eventDate"/>
		<result column="COST" property="cost"/>
		<result column="COST_INFO" property="costInfo"/>
		<result column="TOTAL_POINT" property="totalPoint"/>
		<result column="CAPACITY" property="capacity"/>
		<result column="ONLINE" property="online"/>
		<result column="QUESTION" property="question"/>
		<result column="THUMBNAIL_IMG" property="thumbnailImg"/>
		<result column="CREATE_DATE" property="createDate"/>
		<result column="MODIFY_DATE" property="modifyDate"/>
		<result column="STATUS" property="status"/>
		<result column="COUNT" property="count"/>
		<result column="CATEGORY_NAME1" property="categoryName1"/>
		<result column="CATEGORY_NAME2" property="categoryName2"/>
	</resultMap>
	<resultMap type="ClubReview" id="clubReviewResult">
		<result column="CLUB_REVIEW_NO" property="clubReviewNo"/>
		<result column="REVIEW_CONTENT" property="reviewContent"/>
		<result column="CREATE_DATE" property="createDate"/>
		<result column="MODIFY_DATE" property="modifyDate"/>
		<result column="GRADE" property="grade"/>
		<result column="STATUS" property="status"/>
		<result column="CLUB_NO" property="clubNo"/>
		<result column="USER_NO" property="userNo"/>
	</resultMap>
	<resultMap type="Request" id="requestResult">
		<result column="REQUEST_NO" property="requestNo"/>
		<result column="USER_NO" property="userNo"/>
		<result column="CLUB_NO" property="clubNo"/>
		<result column="ANSWER" property="answer"/>
		<result column="CREATE_DATE" property="createDate"/>
		<result column="STATUS" property="status"/>
		<result column="PAYMENT_NO" property="paymentNo"/>
	</resultMap>
	
	<update id="increaseCount">
		UPDATE CLUB 
		SET COUNT = COUNT + 1
		WHERE
			CLUB_NO = #{cno};
	</update>
	
	<select id="selectClub" resultMap="clubResult">
		SELECT CLUB_NO,
			   USER_NO,
			   CLUB_TITLE,
			   CLUB_TYPE,
			   CLUB_CONTENT,
			   ADDRESS,
			   ADDRESS_DETAIL,
			   EVENT_DATE, 
			   COST,
			   COST_INFO, 
			   TOTAL_POINT, 
			   CAPACITY, 
			   ONLINE,
			   QUESTION,
			   THUMBNAIL_IMG,
			   CREATE_DATE,
			   C.MODIFY_DATE,
			   COUNT,
			   NICKNAME,
			   category_name1,
			   category_name2,
			   profile_img,
			   C.STATUS
	FROM CLUB C
		join MEMBER USING (USER_NO)
	WHERE CLUB_NO = #{cno};
	</select>
	
	<select id="listReview" resultMap="clubReviewResult">
		SELECT CLUB_REVIEW_NO,
			   REVIEW_CONTENT,
			   CR.MODIFY_DATE,
			   GRADE,
			   NICKNAME
		FROM CLUB_REVIEW CR
		JOIN MEMBER USING (USER_NO)
		WHERE CR.STATUS = 'Y'
			AND CLUB_NO = #{cno};
	</select>
	
	<insert id="insertClub">
		INSERT INTO
			club(
					club_no,
					user_no,
					club_title,
					club_type,
					club_content,
					address,
					address_detail,
					event_date,
					cost,
					cost_info,
					capacity,
					online,
					question,
					thumbnail_img,
					category_name1,
					category_name2)
			VALUES (
					NEXTVAL('SEQ_CNO'), 
					#{userNo},
					#{clubTitle},
					#{clubType},
					#{clubContent},
					#{address},
					#{addressDetail},
					#{eventDate},
					#{cost},
					#{costInfo},
					#{capacity},
					#{online},
					#{question},
					#{thumbnailImg},
					#{categoryName1},
					#{categoryName2})
			RETURNING club_no;

		<selectKey keyProperty="clubNo" order="AFTER" resultType="int">
			SELECT CURRVAL('SEQ_CNO') AS clubNo
		</selectKey>
	</insert>
	
	<select id="listClub">
		SELECT CLUB_NO,
			   USER_NO,
			   CLUB_TITLE,
			   CAPACITY,
			   QUESTION,
			   STATUS
		FROM public.CLUB
			join MEMBER USING (USER_NO)
		WHERE public.CLUB.STATUS = 'Y'
			AND USER_NO = #{uno};
	</select>
		
	<select id="selectClubList" resultMap="clubResult">
		SELECT DISTINCT CLUB_NO,
			   C.USER_NO,
			   CLUB_TITLE,
			   CLUB_TYPE,
			   EVENT_DATE,
			   TOTAL_POINT,
			   THUMBNAIL_IMG,
			   C.STATUS,
			   NICKNAME
		  FROM CLUB C
	 LEFT JOIN REQUEST R USING(CLUB_NO)
	 LEFT JOIN MEMBER M ON C.USER_NO = M.USER_NO
		 WHERE R.STATUS = 'Y'
		   AND C.STATUS = 'E'
		   AND M.USER_NO = C.USER_NO
		   AND R.USER_NO = #{uno}
	  ORDER BY EVENT_DATE DESC;
	</select>
	
	<select id="selectRequestList" resultMap="requestResult">
		SELECT REQUEST_NO,
				R.USER_NO,
				CLUB_NO,
				ANSWER,
				R.CREATE_DATE,
				R.STATUS,
				M.NICKNAME
		   FROM REQUEST R
		   JOIN MEMBER M USING (USER_NO)
		  WHERE CLUB_NO = #{cno};
	</select>
	
	<update id="acceptRequest">
		UPDATE REQUEST 
		   SET STATUS = 'Y'
		 WHERE REQUEST_NO = #{rqno};
	</update>
	
	<update id="denyRequest">
		UPDATE REQUEST 
		   SET STATUS = 'N'
		 WHERE REQUEST_NO = #{rqno};
	</update>
	
	<update id="updateClub">
		UPDATE CLUB
		   SET club_title = #{clubTitle},
			   club_type = #{clubType},
			   club_content = #{clubContent},
			   address = #{address},
			   address_detail = #{addressDetail},
			   event_date = #{eventDate},
			   cost = #{cost},
			   cost_info = #{costInfo},
			   capacity = #{capacity},
			   online = #{online},
			   question = #{question},
			   thumbnail_img = #{thumbnailImg},
			   modify_date = CURRENT_DATE,
			   category_name1 = #{categoryName1},
			   category_name2 = #{categoryName2},
			   status = 'Y'
		 WHERE CLUB_NO = #{clubNo}
	</update>
	
	<insert id="insertRequest">
		INSERT INTO
			request(
					request_no,
					user_no,
					club_no,
					answer,
					payment_no
					)
			VALUES (
					NEXTVAL('SEQ_RQNO'), 
					#{userNo},
					#{clubNo},
					#{answer},
					CURRVAL('SEQ_PMNO')
					)
	</insert>
	
	<select id="selectCountReview" resultType="_int">
		SELECT COUNT(*)
		FROM (
				SELECT R.CLUB_REVIEW_NO,
					   R.REVIEW_CONTENT,
					   R.CREATE_DATE,
					   R.GRADE,
					   R.STATUS,
					   R.CLUB_NO,
					   R.USER_NO
				  FROM CLUB_REVIEW R
		    INNER JOIN MEMBER M ON M.USER_NO = R.USER_NO
		    INNER JOIN REQUEST Q ON M.USER_NO = Q.USER_NO
		     	 WHERE R.CLUB_NO = #{cno}
		)
	</select>
	
	<insert id="insertClubReview">
		INSERT INTO
			CLUB_REVIEW(
						CLUB_REVIEW_NO,
						REVIEW_CONTENT,
						GRADE,
						CLUB_NO,
						USER_NO
						)
			VALUES (
					NEXTVAL('SEQ_CRNO'),
					#{reviewContent},
					#{grade},
					#{clubNo},
					#{userNo}
					)
	</insert>
	
	<select id="selectClubReview" parameterType="HashMap" resultMap="clubReviewResult">
			SELECT DISTINCT
				   R.CLUB_REVIEW_NO,
				   R.REVIEW_CONTENT,
				   R.GRADE,
				   R.CLUB_NO,
				   R.USER_NO
			  FROM CLUB_REVIEW R
	    INNER JOIN MEMBER M ON M.USER_NO = R.USER_NO
	    INNER JOIN REQUEST Q ON M.USER_NO = Q.USER_NO
	     	 WHERE R.CLUB_NO = #{cno, jdbcType=BIGINT}
	     	   AND R.USER_NO = #{uno, jdbcType=BIGINT}
	</select>
	<!-- 내가 만든 소셜링 리스트 -->
	<select id="selectMySocialList" resultMap="clubResult">
		SELECT CLUB_NO,
			   USER_NO,
			   CLUB_TITLE,
			   CLUB_TYPE,
			   EVENT_DATE,
			   CAPACITY,
			   THUMBNAIL_IMG,
			   CREATE_DATE,
			   CLUB.MODIFY_DATE,
			   category_name1,
			   category_name2
		  FROM CLUB
		 WHERE USER_NO = #{uno}
		   AND CLUB_TYPE = '소셜링'
		   AND STATUS = 'Y'
	  ORDER BY CREATE_DATE DESC;
	</select>
	<!-- 내가 만든 소셜링 종료된 리스트 -->
	<select id="selectMySocialListDone" resultMap="clubResult">
		SELECT CLUB_NO,
			   USER_NO,
			   CLUB_TITLE,
			   CLUB_TYPE,
			   EVENT_DATE,
			   CAPACITY,
			   THUMBNAIL_IMG,
			   CREATE_DATE,
			   CLUB.MODIFY_DATE,
			   category_name1,
			   category_name2
		  FROM CLUB
		 WHERE USER_NO = #{uno}
		   AND CLUB_TYPE = '소셜링'
		   AND STATUS = 'E'
	  ORDER BY CREATE_DATE DESC;
	</select>
	<!-- 내가 만든 소셜링 종료 -->
	<update id="finishSocial">
		UPDATE CLUB
		   SET STATUS = 'E'
		 WHERE CLUB_NO = #{cno}
		   AND CLUB_TYPE = '소셜링'
	</update>
	
	<update id="finishRequest">
		UPDATE REQUEST
		   SET STATUS = 'F'
		  FROM CLUB
		 WHERE REQUEST.CLUB_NO = CLUB.CLUB_NO
		   AND REQUEST.CLUB_NO = #{cno}
	</update>
	
	<update id="cancleFinishSocial">
		UPDATE CLUB
		   SET STATUS = 'Y'
		 WHERE CLUB_NO = #{cno}
		   AND CLUB_TYPE = '소셜링'
	</update>
	
	<update id="clubRequestReset">
		UPDATE REQUEST
		   SET STATUS = 'F'
		 WHERE STATUS = 'Y'
		   AND CLUB_NO = #{cno}
	</update>
	
	<select id="selectGoSocialList" resultMap="clubResult">
		SELECT C.CLUB_NO,
			   C.USER_NO,
			   C.CLUB_TITLE,
			   C.CLUB_TYPE,
			   C.EVENT_DATE,
			   C.CAPACITY,
			   C.THUMBNAIL_IMG,
			   C.CREATE_DATE,
			   C.category_name1,
			   C.category_name2
		  FROM CLUB C
	 LEFT JOIN REQUEST R USING(CLUB_NO)
	 LEFT JOIN MEMBER M ON C.USER_NO = M.USER_NO
		 WHERE R.STATUS = 'Y'
		   AND C.STATUS = 'Y'
		   AND M.USER_NO = C.USER_NO
		   AND R.USER_NO = #{uno}
		   AND C.CLUB_TYPE = '소셜링'
	  ORDER BY EVENT_DATE DESC;
	</select>
	
	<select id="selectGoSocialListDone" resultMap="clubResult">
		SELECT C.CLUB_NO,
			   C.USER_NO,
			   C.CLUB_TITLE,
			   C.CLUB_TYPE,
			   C.EVENT_DATE,
			   C.CAPACITY,
			   C.THUMBNAIL_IMG,
			   C.CREATE_DATE,
			   C.category_name1,
			   C.category_name2
		  FROM CLUB C
	 LEFT JOIN REQUEST R USING(CLUB_NO)
	 LEFT JOIN MEMBER M ON C.USER_NO = M.USER_NO
		 WHERE R.STATUS = 'F'
		   AND C.STATUS = 'E'
		   AND M.USER_NO = C.USER_NO
		   AND R.USER_NO = #{uno}
		   AND C.CLUB_TYPE = '소셜링'
	  ORDER BY EVENT_DATE DESC;
	</select>
	
	<select id="selectMyChallengeList" resultMap="clubResult">
		SELECT CLUB_NO,
			   USER_NO,
			   CLUB_TITLE,
			   CLUB_TYPE,
			   EVENT_DATE,
			   CAPACITY,
			   THUMBNAIL_IMG,
			   CREATE_DATE,
			   CLUB.MODIFY_DATE,
			   category_name1,
			   category_name2
		  FROM CLUB
		 WHERE USER_NO = #{uno}
		   AND CLUB_TYPE = '챌린지'
		   AND STATUS = 'Y'
	  ORDER BY CREATE_DATE DESC;
	</select>
	
	<select id="selectMyChallengeListDone" resultMap="clubResult">
		SELECT CLUB_NO,
			   USER_NO,
			   CLUB_TITLE,
			   CLUB_TYPE,
			   EVENT_DATE,
			   CAPACITY,
			   THUMBNAIL_IMG,
			   CREATE_DATE,
			   CLUB.MODIFY_DATE,
			   category_name1,
			   category_name2
		  FROM CLUB
		 WHERE USER_NO = #{uno}
		   AND CLUB_TYPE = '챌린지'
		   AND STATUS = 'E'
	  ORDER BY CREATE_DATE DESC;
	</select>
	
	<update id="finishChallenge">
		UPDATE CLUB
		   SET STATUS = 'E'
		 WHERE CLUB_NO = #{cno}
		   AND CLUB_TYPE = '챌린지'
	</update>
	
	<update id="cancleFinishChallenge">
		UPDATE CLUB
		   SET STATUS = 'Y'
		 WHERE CLUB_NO = #{cno}
		   AND CLUB_TYPE = '챌린지'
	</update>
	
	<update id="quitClub" parameterType="HashMap">
		UPDATE REQUEST
		   SET STATUS = 'Q'
		 WHERE CLUB_NO = #{cno, jdbcType=BIGINT}
		   AND USER_NO = #{uno, jdbcType=BIGINT}
	</update>
	
	<!-- 찜한 소셜링 리스트 -->
	<select id="selectMyDibsSocialList" parameterType="Club" resultMap="clubResult">
		SELECT c.CLUB_NO,
			   c.USER_NO,
			   c.CLUB_TITLE,
			   c.CLUB_TYPE,
			   c.EVENT_DATE,
			   c.CAPACITY,
			   c.THUMBNAIL_IMG,
			   c.CREATE_DATE,
			   c.MODIFY_DATE,
			   c.category_name1,
			   c.category_name2
		  FROM club AS c
		 inner join picked AS p on c.club_no = p.club_no
		  where p.user_no = #{userNo}
			AND c.status = 'Y'
			AND c.club_type = '소셜링'
	   order by c.event_date desc
	</select>
	
	<!-- 찜한 챌린지 리스트 -->
	<select id="selectMyDibsChallengeList" parameterType="Club" resultMap="clubResult">
		SELECT c.CLUB_NO,
			   c.USER_NO,
			   c.CLUB_TITLE,
			   c.CLUB_TYPE,
			   c.EVENT_DATE,
			   c.CAPACITY,
			   c.THUMBNAIL_IMG,
			   c.CREATE_DATE,
			   c.MODIFY_DATE,
			   c.category_name1,
			   c.category_name2
		  FROM club AS c
		 inner join picked AS p on c.club_no = p.club_no
		  where p.user_no = #{userNo}
			AND c.status = 'Y'
			AND c.club_type = '챌린지'
	   order by c.event_date desc
	</select>
	
	<!-- cno로 request 정보 가져오기 status f 아닌것 -->
	<select id="selectListRequestNotF" resultMap="requestResult">
		select request_no,
			   payment_no
		from request
		where status != 'F'
			and club_no = #{cno} 
	</select>
	
	<update id="deleteClub">
		update club
		set status = 'N'
		where club_no = #{cno}
	</update>
</mapper>